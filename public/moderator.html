<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Musik-Quiz â€“ Moderator</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h3 class="h">Playlists (Runden)</h3>
      <div id="roundList" class="list"></div>
      <div class="status"><span>Raumcode: </span><code id="roomCode" class="small">â€”</code></div>
    </aside>

    <main class="main">
      <h3 class="h">Runde: <span id="roundName">â€“</span></h3>
      <div class="status">Aktueller Song: <strong id="currentTitle">â€“</strong></div>
      <div id="correctBox" class="status">Richtige Antwort: <strong id="correctAnswer">â€“</strong></div>
      <div id="songList" class="songs"></div>

      <div class="row" style="margin-top:12px; gap:8px; flex-wrap:wrap;">
        <button id="btnCreate" class="primary">Raum erstellen</button>
        <button id="btnStart">â–¶ï¸ Start</button>
        <button id="btnPlay">â–¶ï¸ Play</button>
        <button id="btnPause">â¸ï¸ Pause</button>
        <button id="btnUnlock">ğŸ”“ Buzzer freigeben</button>
        <button id="btnNext">â­ï¸ NÃ¤chster Song</button>
        <button id="btnRefresh">ğŸ”„ Seiten neu laden</button>
      </div>

      <audio id="audio" controls></audio>
      <div id="status" class="status"></div>

      <div class="row" style="margin-top:10px;">
        <button id="btnCorrect" class="ok">âœ… Richtig</button>
        <button id="btnWrong" class="err">âŒ Falsch</button>
      </div>
    </main>

    <aside class="right">
      <h3 class="h">Spieler & Punkte</h3>
      <div id="players" class="score"></div>
    </aside>
  </div>

  <script type="module">
    const socket = io();
    const el = sel => document.querySelector(sel);
    const roundList = el('#roundList');
    const songList  = el('#songList');
    const audio     = el('#audio');

    // --- Auto-Resume des Moderators nach Reload -----------------
    try {
      const savedMod = JSON.parse(localStorage.getItem('mq_mod') || 'null');
      if (savedMod?.code) socket.emit('mod:hello', { code: savedMod.code });
    } catch {}

    // Serverseitiger Reload-Befehl
    socket.on('ui:refresh', () => { location.reload(); });

    // â”€â”€ Buzz-Markierung (Moderator) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window._modLastFirstBuzzer = null;

    function modHighlightBuzz(by){
      const list = document.querySelector('#players');
      if (!list) return;
      list.querySelectorAll('.player').forEach(div => {
        const nameEl = div.querySelector('span');
        const name = nameEl ? nameEl.textContent.trim() : '';
        const matchById   = by?.id   && div.dataset?.pid === String(by.id);
        const matchByName = by?.name && name === by.name;
        div.classList.toggle('buzzing', !!(matchById || matchByName));
      });
    }
    function modClearBuzz(){
      document.querySelectorAll('#players .player.buzzing')
        .forEach(div => div.classList.remove('buzzing'));
    }

    // â”€â”€ FX: Animation beim Playlist-Wechsel (Moderator) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function playlistSwitchFXMod(){
      const rn    = el('#roundName');
      const songs = el('#songList');
      const list  = el('#roundList');

      [rn, songs].forEach(n => {
        if (!n) return;
        n.classList.remove('pl-switch');
        void n.offsetWidth;              // Reflow â†’ Animation resetten
        n.classList.add('pl-switch');
      });

      const active = list?.querySelector('.item.active');
      if (active){
        active.classList.add('just-activated');
        setTimeout(() => active.classList.remove('just-activated'), 900);
      }
    }

    // Buttons
    el('#btnCreate').onclick = () => socket.emit('mod:create-room');
    el('#btnStart').onclick  = () => socket.emit('mod:start-round');
    el('#btnPlay').onclick   = () => socket.emit('mod:play');
    el('#btnPause').onclick  = () => socket.emit('mod:pause');
    el('#btnUnlock').onclick = () => socket.emit('mod:unlock');
    el('#btnNext').onclick   = () => socket.emit('mod:next');
    el('#btnRefresh').onclick = () => socket.emit('mod:refresh');

    el('#btnCorrect').onclick = () => socket.emit('mod:result', { type: 'correct' });
    el('#btnWrong').onclick   = () => socket.emit('mod:result', { type: 'wrong' });

    // Rendering Helpers
    function renderRounds(playlists, activeIndex){
      roundList.innerHTML = '';
      playlists.forEach((pl, i) => {
        const div = document.createElement('div');
        div.className   = 'item' + (i===activeIndex ? ' active' : '');
        div.textContent = pl.name || `Playlist ${i+1}`;
        div.onclick     = () => socket.emit('mod:set-round', { index: i });
        roundList.appendChild(div);
      });
    }
    function renderSongs(total, active, currentTitle){
      songList.innerHTML = '';
      for (let i = total; i >= 1; i--) {
        const idxFromTop = i - 1; // 0..N-1
        const div  = document.createElement('div');
        div.className = 'song' + (idxFromTop===active ? ' active' : '');
        const left  = document.createElement('div');
        left.textContent = `Song ${i}`;
        const right = document.createElement('div');
        right.className = 'badge';
        if (idxFromTop===active && currentTitle) right.textContent = currentTitle;
        div.appendChild(left); div.appendChild(right);
        songList.appendChild(div);
      }
    }

    // â”€â”€ Spielerliste rendern (mit +/â€“) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPlayersWithScores(players = [], scores = {}){
      const list = el('#players');
      list.innerHTML = '';
      players.forEach(p => {
        const score = scores[p.id] || 0;
        const div = document.createElement('div');
        div.className   = 'player';
        div.dataset.pid = String(p.id ?? '');
        div.dataset.name = p.name ?? '';
        div.innerHTML = `
          <span>${p.name}</span>
          <strong>${score}</strong>
          <div class="pm">
            <button class="score-btn minus" data-delta="-1" data-pid="${p.id}">âˆ’</button>
            <button class="score-btn plus"  data-delta="1"  data-pid="${p.id}">+</button>
          </div>
        `;
        list.appendChild(div);
      });
      if (window._modLastFirstBuzzer) modHighlightBuzz(window._modLastFirstBuzzer); // Re-Apply Markierung
    }

    // Klick-Handler fÃ¼r +/â€“
    el('#players').addEventListener('click', (e) => {
      const btn = e.target.closest('.score-btn');
      if (!btn) return;
      const pid   = btn.dataset.pid;
      const delta = parseInt(btn.dataset.delta, 10) || 0;
      if (!pid || !delta) return;
      socket.emit('mod:score-delta', { playerId: pid, delta });
    });

    // â”€â”€ Socket Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('mod:room-created', ({ code, progress, playlists }) => {
      el('#roomCode').textContent = code;
      el('#roundName').textContent = progress.roundName;
      renderRounds(playlists, progress.roundIndex - 1);
      renderSongs(progress.songTotal, progress.songIndex - 1, '');
      // Initialindex merken, damit der erste ui:round-update nicht animiert
      window._modLastRoundIndex = progress.roundIndex - 1;

      // Raumcode im LocalStorage merken (fÃ¼r Auto-Resume)
      try { localStorage.setItem('mq_mod', JSON.stringify({ code })); } catch {}
    });

    socket.on('ui:round-update', ({ progress, playlists, activeRound, activeSong, currentTitle }) => {
      const was = window._modLastRoundIndex;
      el('#roundName').textContent = progress.roundName;

      renderRounds(playlists, activeRound);
      renderSongs(progress.songTotal, activeSong, currentTitle||'');

      if (was !== undefined && was !== activeRound) {
        playlistSwitchFXMod();
      }
      window._modLastRoundIndex = activeRound;
    });

    socket.on('round:prepare', ({ src, title, playlistName, solution }) => {
      audio.src = src || '';
      el('#currentTitle').textContent = title || 'â€“';
      const ca = document.querySelector('#correctAnswer'); if (ca) ca.textContent = solution || 'â€“';
      window._currentPlaylistName = playlistName || null;
      const st = el('#status'); if (st) st.textContent = '';
    });

    socket.on('audio:play',  () => audio.play().catch(()=>{}));
    socket.on('audio:pause', () => audio.pause());

    // Buzz â†’ markieren + merken
    socket.on('buzz:first', (payload = {}) => {
      const { name, id } = payload;
      const st = el('#status');
      if (st) st.textContent = `ğŸ”” ${name || 'Ein Spieler'} hat zuerst gebuzzert!`;
      window._modLastFirstBuzzer = (id ? { id, name } : { name });
      modHighlightBuzz(window._modLastFirstBuzzer);
    });

    // Freigabe â†’ Markierung entfernen
    socket.on('buzz:unlock', () => {
      modClearBuzz();
      window._modLastFirstBuzzer = null;
      const st = el('#status'); if (st) st.textContent = '';
    });

    // Punkte-Update
    socket.on('scores:update', (scores) => {
      const players = window._players || [];
      renderPlayersWithScores(players, scores || {});
    });

    // Spieler-Update
    socket.on('room:update', ({ players, scores }) => {
      window._players = players;
      renderPlayersWithScores(players, scores || {});
    });

    socket.on('progress:update', (p) => {
      el('#roundName').textContent = p.roundName;
    });

    socket.on('status', (t) => el('#status').textContent = t);

    // Runde gelÃ¶st â†’ Sidebar-Label ersetzen (und Ãœberschrift ggf. auch)
    socket.on('round:solved', ({ playlistName, solution }) => {
      replacePlaylistLabel(playlistName, solution);
      const rn = document.querySelector('#roundName');
      if (rn && rn.textContent.trim() === playlistName) rn.textContent = solution;
    });

    function replacePlaylistLabel(originalName, newLabel){
      if (!originalName || !newLabel) return;
      const items = Array.from(document.querySelectorAll('#roundList .item'));
      const item = items.find(el => el.textContent.trim() === originalName);
      if (item) item.textContent = newLabel;
    }
  </script>
</body>
</html>
